import time
import pandas as pd
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from webdriver_manager.chrome import ChromeDriverManager
import urllib.parse

# ğŸ“„ Ruta del archivo Excel
excel_path = r"C:\Users\LENOVO\Desktop\William Herrrera\SEPTIEMBRE\CARNETS\CARNETIZACION.xlsx"

# ğŸŒ LINK DEL SALUDO (GitHub Pages)
saludo_link = "https://willher1984.github.io/SALUDO-CONSORCIO/"

# ğŸ“˜ Cargar archivo
df = pd.read_excel(excel_path)

# âš™ï¸ ConfiguraciÃ³n de Chrome
options = Options()
options.add_experimental_option("detach", True)
options.add_argument("--start-maximized")

# ğŸš€ Iniciar navegador
driver = webdriver.Chrome(
    service=Service(ChromeDriverManager().install()),
    options=options
)

# ğŸŒ Abrir WhatsApp Web
driver.get("https://web.whatsapp.com/")
print("ğŸ“± Escanea el cÃ³digo QR con tu celular para iniciar sesiÃ³n...")
time.sleep(25)

# ğŸ” Enviar mensajes
for i, row in df.iterrows():
    numero = str(row["NUMERO DE CEL"]).strip()
    nombre = str(row.iloc[2]).strip()  # Columna C

    if not numero.isdigit():
        print(f"âš ï¸ NÃºmero invÃ¡lido en fila {i+2}: {numero}")
        df.at[i, "ENVIADO"] = "âŒ NÃºmero invÃ¡lido"
        continue

    mensaje = (
        f"Hola {nombre} ğŸ‘‹\n\n"
        f"Te saludamos desde *Consorcio BFTEL* ğŸ„âœ¨\n\n"
        f"Preparamos un mensaje especial para esta temporada:\n\n"
        f"ğŸ‘‰ {saludo_link}\n\n"
        f"*Feliz Navidad y prÃ³spero AÃ±o Nuevo* ğŸğŸ†\n"
        f"*Consorcio BFTEL*"
    )

    mensaje_encoded = urllib.parse.quote(mensaje)

    link = (
        "https://web.whatsapp.com/send?"
        f"phone=57{numero}&"
        f"text={mensaje_encoded}"
    )

    driver.get(link)

    try:
        # âŒ¨ï¸ Esperar caja de texto
        textbox = WebDriverWait(driver, 25).until(
            EC.presence_of_element_located((By.XPATH, '//div[@role="textbox"]'))
        )
        time.sleep(2)

        # ğŸ“¤ Enviar mensaje
        textbox.send_keys("\n")

        print(f"âœ… Mensaje enviado a {nombre} ({numero})")
        df.at[i, "ENVIADO"] = "âœ… Enviado"

    except Exception as e:
        print(f"âŒ Error enviando a {numero}: {e}")
        df.at[i, "ENVIADO"] = "âŒ Error"

    time.sleep(5)

# ğŸ’¾ Guardar resultados
df.to_excel(excel_path, index=False)
print("ğŸ“„ EnvÃ­os finalizados. Revisa la columna 'ENVIADO' en tu Excel.")



